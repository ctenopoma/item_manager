メール通知設定
========================================

本システムでは、返却期限に基づいたメール通知機能を備えています。
設定は管理画面から行い、自動的に対象者へメールが送信されます。

通知の仕組み
----------------------------------------

以下のタイミングでメールが送信されます。

1.  **期限前のリマインダー**: 返却期限の **N日前** に送信
2.  **当日の通知**: 返却期限 **当日** に送信
3.  **期限切れの通知**: 返却期限を過ぎた場合、 **M日ごと** に繰り返し送信

設定方法
----------------------------------------

管理者ユーザーでログインし、管理画面（ ``/admin`` ）にアクセスしてください。

通知設定 (Notification Settings)
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

メニューの `Notification Settings` から以下の項目を設定できます。

*   **N Days Before**: リマインダーを送信する日数（デフォルト: 3）
*   **M Days Overdue**: 期限切れ通知を再送する間隔（デフォルト: 7）
*   **Sender Email**: メールの送信元アドレス
*   **SMTP Server**: SMTPサーバーのホスト名（例: smtp.gmail.com）
*   **SMTP Port**: SMTPサーバーのポート番号（例: 587）
*   **SMTP Username**: SMTP認証のユーザー名
*   **SMTP Password**: SMTP認証のパスワード（アプリパスワード等）

.. note::
    Gmailを使用する場合は、アカウントの設定で「アプリパスワード」を生成して使用することを推奨します。

メールテンプレート (Email Templates)
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

メニューの `Email Templates` からメールの件名と本文を編集できます。
以下の `name` を持つテンプレートがシステムによって使用されます。

*   ``reminder_before``: 期限前リマインダー用
*   ``due_date``: 当日用
*   ``overdue``: 期限切れ用

**使用可能なプレースホルダー**

本文（Body）には以下の変数を埋め込むことができます。

*   ``{user_name}``: 借主の名前
*   ``{item_name}``: アイテム名
*   ``{due_date}``: 返却期限
*   ``{days_overdue}``: 超過日数（期限切れメールのみ）

例::

    件名: 【重要】{item_name}の返却期限が過ぎています

    本文:
    {user_name} 様

    お借りいただいている {item_name} の返却期限（{due_date}）を過ぎています。
    現在 {days_overdue} 日超過しております。
    速やかに返却をお願いいたします。

設定の確認
----------------------------------------

正しく設定されているか確認するために、スタンドアローンの確認スクリプトが用意されています。
プロジェクトルートで以下のコマンドを実行してください。

.. code-block:: bash

    uv run python sample_email_config.py

SMTP設定を入力すると、テストメールの送信を試みます。
