# 物品管理システム 基本設計書

## 1. ディレクトリ構成・モジュール設計

FastAPIの標準的な構成を採用し、責務ごとにファイルを分割する。

```mermaid :Plaintext

inventory_app/
├── main.py              # アプリケーションのエントリーポイント
├── database.py          # DB接続設定 (SessionLocal, Base)
├── models.py            # SQLAlchemy モデル定義 (DBテーブル定義)
├── schemas.py           # Pydantic モデル定義 (型定義・バリデーション)
├── crud.py              # DB操作関数群 (Create, Read, Update, Delete)
├── security.py          # 認証関連 (パスワードハッシュ, JWT生成)
├── routers/             # ルーティング定義
│   ├── auth.py          # ログイン・認証関連
│   ├── items.py         # 物品操作関連 (API & 画面)
│   ├── users.py         # ユーザー管理関連 (Admin用)
│   └── growi.py         # Growi連携用API
├── templates/           # Jinja2 HTMLテンプレート
│   ├── base.html        # 共通レイアウト
│   ├── login.html       # ログイン画面
│   ├── dashboard.html   # 管理者ダッシュボード
│   └── items.html       # 物品一覧・操作画面
└── static/              # CSS, JS, 画像ファイル
```

2. データベース設計 (ER図)

Users (ユーザー), Items (物品), Logs (履歴) の3テーブルで構成する。

```mermaid :erDiagram
    Users ||--o{ Items : "currently owns"
    Users ||--o{ Logs : "performs"
    Items ||--o{ Logs : "is target of"

    Users {
        int id PK
        string username UK "社員番号/ID"
        string hashed_password
        string display_name
        string role "admin/user"
        boolean is_active
    }

    Items {
        int id PK
        string name
        string management_code UK "管理番号"
        string category
        string status "available/borrowed/broken"
        int owner_id FK "Users.id (Nullable)"
        date due_date "Nullable"
    }

    Logs {
        int id PK
        int item_id FK
        int user_id FK
        string action "borrow/return"
        datetime created_at
    }
```

## 3. クラス・変数仕様

### 3.1 クラス図 (Models & Schemas)

DBモデル(ORM)と、API通信用スキーマ(Pydantic)の関係定義。

``` コード スニペットclassDiagram
    class User_Model {
        +int id
        +str username
        +str display_name
        +str role
    }
    class Item_Model {
        +int id
        +str name
        +str status
        +int owner_id
        +date due_date
    }

    class ItemCreate_Schema {
        +str name
        +str management_code
        +str category
    }
    class ItemResponse_Schema {
        +int id
        +str name
        +str status
        +str owner_name
        +bool is_overdue
    }
    
    %% 関係性
    User_Model "1" -- "*" Item_Model : 貸出中
    ItemCreate_Schema ..> Item_Model : 作成時入力
    Item_Model ..> ItemResponse_Schema : API応答
```

### 3.2 変数・データ型詳細 (schemas.py)

|クラス名|用途|主要フィールド (型)|
|-|-|-|
|UserCreate|ユーザー登録入力|username(str), password(str), display_name(str)|
|Token認証トークン|access_token(str), token_type(str)
|ItemCreate|物品登録入力|name(str), code(str), category(str)|
|ItemUpdate|貸出・返却更新|status(str), due_date(date)|
|GrowiItem|Growi連携レスポンス|name, code, status, owner, due_date, is_overdue(bool)|


## 4. インターフェース仕様

### 4.1 ページ遷移 (Web UI)

|URLパス|メソッド|画面名称|権限|説明|
|-|-|-|-|-|
|/login|GET/POST|ログイン画面|全員|認証を行う|
|/users|GET|ユーザー管理|Admin|ユーザー一覧・登録|
|/items|GET|物品一覧|Auth|在庫一覧、検索、貸出操作|
|/my|GET|マイページ|Auth|自身の借用中物品、返却操作|

### 4.2 APIエンドポイント (内部処理 & Growi連携)

|URLパス|メソッド|機能概要|入力パラメータ|レスポンス|
|-|-|-|-|-|
|/api/v1/items/{id}/borrow|POST|貸出処理|due_date|成功/失敗ステータス|
|/api/v1/items/{id}/return|POST|返却処理なし|成功/失敗ステータス|
|/api/v1/growi/status|GET|Growi表示用|なし|List[GrowiItem] (JSON)|

## 5. 関数・処理フロー仕様

### 5.1 貸出処理フロー (Borrow Item)

排他制御を行い、他人が貸出中の場合はエラーとする

```コード スニペット
sequenceDiagram
    participant User as ユーザー(Browser)
    participant Web as FastAPI(Router)
    participant Logic as CRUD Logic
    participant DB as Database

    User->>Web: POST /items/{id}/borrow (返却予定日)
    activate Web
    Web->>Logic: borrow_item(db, item_id, user_id, date)
    activate Logic
    
    Logic->>DB: Select Item (排他制御)
    
    alt 在庫あり (Available)
        Logic->>DB: Update Item (status='borrowed', owner=user)
        Logic->>DB: Insert Log (action='borrow')
        DB-->>Logic: Commit OK
        Logic-->>Web: Success
        Web-->>User: 完了メッセージ & 一覧リロード
    else 貸出中 (Borrowed)
        Logic-->>Web: Error "既に貸出中です"
        Web-->>User: エラー表示
    end
    deactivate Logic
    deactivate Web
```

### 5.2 Growi連携フロー (Get Status)
Growi側からのリクエストに応じ、現在のステータスと「延滞フラグ」を計算して返す。

```コード スニペット
sequenceDiagram
    participant Growi as Growi (Browser JS)
    participant API as FastAPI (Growi Endpoint)
    participant DB as Database

    Growi->>API: GET /api/v1/growi/status
    activate API
    API->>DB: Query All Items (Join Users)
    DB-->>API: Result List
    
    loop 各アイテムについて
        API->>API: 延滞判定 (Today > due_date ?)
        API->>API: JSONデータ整形 (is_overdueフラグ付与)
    end
    
    API-->>Growi: JSON Response
    deactivate API
    
    Growi->>Growi: HTMLテーブル描画 (延滞行を赤く表示)
```

## 6. テスト方針

- ツール: pytest, httpx (FastAPIのTestClient)
- 環境: テスト実行時のみ作成されるオンメモリSQLiteデータベースを使用し、毎回クリーンな状態でテストを行う（副作用を排除）。
- 範囲:
    - 正常系: 想定通りの操作でデータが正しく更新されること。
    - 異常系: 存在しないID、権限不足、不正なステータス遷移（貸出中に貸出など）で適切なエラーコードが返ること。

## 7. テストケース一覧

優先度の高い順にカテゴリ分けしました。特に「C. 業務ロジック」がシステムの肝となります。

#### A. 認証・認可 (Auth)

|ID|テスト項目|前提条件|操作 (API Request)|期待値 (Assert)|
|-|-|-|-|-|
|A-1|ログイン成功|登録済ユーザーあり|POST /token (正しいID/PW)|200 OK, access_tokenが返却される|
|A-2|ログイン失敗|なし|POST /token (誤ったPW)|401 Unauthorized|
|A-3|管理者権限チェック|一般ユーザーでLogin|POST /api/v1/users (作成)|403 Forbidden|

#### B. マスター管理 (CRUD)

|ID|テスト項目|前提条件|操作 (API Request)|期待値 (Assert)|
|-|-|-|-|-|
|B-1|物品登録(正常)|AdminでLogin|POST /api/v1/items|201 Created, DBにデータが存在する|
|B-2|物品取得(一覧)|データ数件あり|GET /api/v1/items|200 OK, リストが返却される|
|B-3|物品削除(正常)|対象データあり|DELETE /api/v1/items/{id}|204 No Content, DBから消えている|
|B-4|存在しない物品|操作なし|GET /api/v1/items/9999|404 Not Found|

#### C. 業務ロジック (Operations) - 最重要

貸出・返却の整合性を担保するテスト群です。

|ID|テスト項目|前提条件|操作 (API Request)|期待値 (Assert)|
|-|-|-|-|-|
|C-1|貸出成功|ステータス: Available|POST .../{id}/borrow|200 OK, Status=borrowed, Owner=自分|
|C-2|二重貸出防止|ステータス: BorrowedPOST .../{id}/borrow|400 Bad Request (既に借りられている)|
|C-3|返却成功|自分が借用中|POST .../{id}/return|200 OK, Status=available, Owner=None|
|C-4|他人による返却|他人が借用中|POST .../{id}/return|403 Forbidden (借りた本人しか返せない)|
|C-5|未貸出の返却|ステータス: Available|POST .../{id}/return|400 Bad Request (借りていない)|

#### D. 外部連携 (Growi API)

|ID|テスト項目|前提条件|操作 (API Request)|期待値 (Assert)|
|-|-|-|-|-|
|D-1|延滞フラグ判定|返却期限切れの物品あり|GET /api/v1/growi/status|JSON内の is_overdue が true であること|

## 8. 実装イメージ (Pytest)

実際のコード構成案です。conftest.py でテスト用DBの準備を行うのがポイントです。

### 8.1 ディレクトリ構成

```Plaintexttests/
├── conftest.py          # 共通フィクスチャ (DB接続, TestClient, ダミーデータ作成)
├── test_auth.py         # 認証系のテスト
├── test_items_crud.py   # 管理者機能のテスト
└── test_operations.py   # 貸出・返却ロジックのテスト (最重要)
```

### 8.2 共通設定 (tests/conftest.py)

テストごとにDBを作成・破棄し、テスト用クライアントを提供する設定です。
``` Python
import pytest
from fastapi.testclient import TestClient
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker
from sqlalchemy.pool import StaticPool

from main import app
from database import Base, get_db
from models import User, Item

# オンメモリDBを使用 (高速かつクリーン)
SQLALCHEMY_DATABASE_URL = "sqlite:///:memory:"

engine = create_engine(
    SQLALCHEMY_DATABASE_URL,
    connect_args={"check_same_thread": False},
    poolclass=StaticPool,
)
TestingSessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)

# DBの依存関係をオーバーライド
def override_get_db():
    try:
        db = TestingSessionLocal()
        yield db
    finally:
        db.close()

app.dependency_overrides[get_db] = override_get_db

@pytest.fixture(scope="function")
def client():
    # テストのたびにテーブルを作り直す
    Base.metadata.create_all(bind=engine)
    with TestClient(app) as c:
        yield c
    Base.metadata.drop_all(bind=engine)

@pytest.fixture
def token_headers(client):
    # テスト用ユーザー作成＆トークン取得のヘルパー
    user = User(username="testuser", hashed_password="hashed_secret", role="user")
    db = TestingSessionLocal()
    db.add(user)
    db.commit()
    # ここでログインAPIを叩いてトークンを取得する処理を書く
    # return {"Authorization": f"Bearer {token}"}
    return {} # 簡略化
```

### 8.3 貸出ロジックのテスト実装例 (tests/test_operations.py)

要件定義で最も重要な「貸出・返却」のテストコード例です。

```Python

def test_borrow_item_success(client, token_headers):
    """
    正常に借りられるかテスト
    """
    # 1. 物品を作成
    client.post("/api/v1/items", json={"name": "PC1", "status": "available"}, headers=token_headers)
    
    # 2. 借りる
    response = client.post("/api/v1/items/1/borrow", json={"due_date": "2025-12-31"}, headers=token_headers)
    assert response.status_code == 200
    
    # 3. 状態確認
    item = client.get("/api/v1/items/1", headers=token_headers).json()
    assert item["status"] == "borrowed"
    assert item["owner_id"] is not None

def test_borrow_conflict(client, token_headers):
    """
    貸出中のものを借りようとしたらエラーになるかテスト
    """
    # 1. 物品を作成し、状態を 'borrowed' にする
    # (Setup処理は省略)
    
    # 2. 重ねて借りる
    response = client.post("/api/v1/items/1/borrow", json={"due_date": "2026-01-01"}, headers=token_headers)
    
    # 3. 400エラーなどを期待
    assert response.status_code == 400
    assert "already borrowed" in response.json()["detail"]
```
